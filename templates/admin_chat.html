{% extends "base.html" %}

{% block title %}Chat with {{ student.name }} - CourseHub Admin{% endblock %}

{% block content %}
<div class="chat-container" data-student-id="{{ student.id }}" data-student-name="{{ student.name }}">
  <div class="chat-card">
    <div class="chat-header">
      <strong>Chat with {{ student.name }} ({{ student.usn }})</strong>
    </div>
    <div class="chat-body" id="chatBody">
      {% for m in messages %}
      <div class="msg {% if m.sender == 'admin' %}me{% else %}them{% endif %}">
        <div class="bubble">
          <strong style="display:block; font-size:12px; color: var(--text-secondary);">{% if m.sender == 'admin' %}Admin{% else %}{{ student.name }}{% endif %}</strong>
          {{ m.message }}
          <span class="time">{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="Type a reply..." />
      <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
const bodyEl = document.getElementById('chatBody');
const chatEl = document.querySelector('.chat-container');
const studentId = chatEl.dataset.studentId;
const studentName = chatEl.dataset.studentName;
function scrollBottom(){ bodyEl.scrollTop = bodyEl.scrollHeight; }
scrollBottom();

function renderMessage(msg){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (msg.sender === 'admin' ? 'me' : 'them');
  const label = msg.sender === 'admin' ? 'Admin' : studentName;
  wrap.innerHTML = `<div class="bubble"><strong style=\"display:block; font-size:12px; color: var(--text-secondary);\">${label}</strong>${escapeHtml(msg.message)}<span class=\"time\">${msg.time}</span></div>`;
  bodyEl.appendChild(wrap);
  scrollBottom();
}

function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  fetch('/api/chat/send', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: text, student_id: studentId })
  }).then(r=>r.json()).then(d=>{
    if(d.success){
      renderMessage({ sender:'admin', message:text, time:d.time });
      input.value='';
    }
  });
}

function escapeHtml(str){
  const p = document.createElement('p');
  p.appendChild(document.createTextNode(str));
  return p.innerHTML;
}

// Polling for new messages
setInterval(()=>{
  fetch('/api/chat/history/' + encodeURIComponent(studentId))
    .then(r=>r.json()).then(d=>{
      if(d.success){
        bodyEl.innerHTML = '';
        d.messages.forEach(renderMessage);
      }
    });
}, 5000);
</script>
{% endblock %}


